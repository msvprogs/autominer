@using Msv.AutoMiner.FrontEnd.Controllers
@model Msv.AutoMiner.FrontEnd.Models.Rigs.RigDisplayModel[]
    
@if (TempData[RigsController.RigsMessageKey] != null)
{
    <div class="panel panel-success">
        <div class="panel-body text-success">
            @TempData[RigsController.RigsMessageKey]
        </div>
    </div>
}

<h2 class="text-center">Rigs</h2>
<div class="pull-right div-table-actions">
    <a class="btn btn-info" asp-action="Create">
        <i class="glyphicon glyphicon-plus"></i> Add new rig...
    </a>
</div>    

<table class="table table-bordered table-striped">
    <tr>
        <th>Name</th>
        <th>Certificate serial</th>
        <th>Last heartbeat</th>
        <th class="column-actions">Actions</th>
    </tr>
    @foreach (var rig in Model.OrderBy(x => x.Name))
    {
        string rowClass;
        string title;
        if (!rig.IsActive)
        {
            rowClass = "text-muted";
            title = "Rig is inactive";
        }
        else if (rig.CertificateSerial == null)
        {
            rowClass = "warning";
            title = "Certificate for the rig isn't registered";
        }
        else if (rig.LastHeartbeat == null || rig.LastHeartbeat < DateTime.UtcNow - TimeSpan.FromMinutes(10))
        {
            rowClass = "warning";
            title = "Rig data is unavailable or obsolete, no recent heartbeats";
        }
        else
        {
            rowClass = null;
            title = null;
        }

        <tr class="@rowClass" title="@title">
            <td><a asp-action="Statistics" asp-route-id="@rig.Id" title="Show statistics">@rig.Name</a></td>
            <td>@rig.CertificateSerial</td>
            <td msv-absolute-date="@rig.LastHeartbeat"></td>
            <td>
                <ul class="list-inline">
                    <li>
                        <a class="btn btn-xs btn-primary" asp-action="Edit" asp-route-id="@rig.Id" title="Edit rig">
                            <i class="glyphicon glyphicon-edit"></i>
                        </a>
                    </li>
                    <li>
                        @{
                            var activationButtonTitle = rig.IsActive
                                ? "Disable rig"
                                : "Enable rig";
                        }
                        <form asp-action="ToggleActive" asp-route-id="@rig.Id" method="post" title="@activationButtonTitle">
                            <button class="btn btn-xs btn-info">
                                @if (rig.IsActive)
                                {
                                    <i class="glyphicon glyphicon-remove"></i>
                                }
                                else
                                {
                                    <i class="glyphicon glyphicon-flash"></i>
                                }
                            </button>
                        </form>
                    </li>
                    <li>
                        @if (rig.CertificateSerial == null)
                        {
                            <a class="btn btn-xs btn-info" 
                               asp-action="CreateRegistrationRequest" asp-route-id="@rig.Id" title="Register rig">
                                <i class="fa fa-user-plus" aria-hidden="true"></i>
                            </a>
                        }
                        else
                        {
                            <a class="btn btn-xs btn-info"
                               asp-action="RevokeCertificate" asp-route-id="@rig.Id" title="Revoke rig certificate">
                                <i class="fa fa-user-times" aria-hidden="true"></i>
                            </a>
                        }
                    </li>
                </ul>
            </td>
        </tr>
    }
</table>

@section Scripts {
    <script>
        $("a[href*='CreateRegistrationRequest']").click(function() {
            showModal(this.href);
            return false;
        });
        $("a[href*='RevokeCertificate']").click(function () {
            confirmAndPost(this.href);
            return false;
        });
    </script>
}